@model EventCombo.Models.Promo_Code
@{
    ViewBag.Title = "CreatePromotionalCodes";
    Layout = "~/Views/Shared/_AccountLayout.cshtml";
}
<link href="~/Content/jquery-ui.css" rel="stylesheet" />
<link href="~/Content/DateTimePicker.css" rel="stylesheet" />
<script src="~/Scripts/jquery.masked.js"></script>
@section sidenav{
    <div id="sidebar" class="nav nav-stacked">
        <div id="accordion" class="panel-group">

            <div class="panel panel-default menu_list">

                <a class="menu_title"  href="#">
                    <div class="panel-heading ">
                        < My Account 

                    </div>
                </a>
            </div>
            <div class="panel panel-default menu_list">
                <a class="menu_title" href="#" title="@Model.Eventitle">
                    <div class="panel-heading activeyellow act_ellipses">
                        @Model.Eventitle
                    </div>
                </a>
            </div>
            <div class="panel panel-default menu_list">
                <a class="menu_title" href="#">
                    <div class="panel-heading">
                        Event Help
                    </div>
                </a>
            </div>
            <div class="panel panel-default menu_list">
                <a class="menu_title" href="#">
                    <div class="panel-heading">
                        Event Bundles
                    </div>
                </a>
            </div>
            <div class="panel panel-default menu_list">
                <a class="menu_title" href="#">
                    <div class="panel-heading">
                        Event Dashboard
                    </div>
                </a>
            </div>
            <div class="panel panel-default menu_list">
                <a class="menu_title" href="#">
                    <div class="panel-heading">
                        Modify Order Options
                    </div>
                </a>
            </div>
            <div class="panel panel-default menu_list">

                <a id="mgnav" class="menu_title" data-toggle="collapse" data-parent="#accordion" href="#collapse2">
                    <div id="dvManage" class="panel-heading">
                        Invite and Promote <b class="closed"></b>
                    </div>
                </a>

                <div id="collapse2" class="panel-collapse collapse">
                    <div class="panel-body no-padding">
                        <p>Email Invitations</p>
                        @if (Model.discountcode > 0)
                        {
                            <p>@Html.ActionLink("Promotional Code", "PromotionalCodes", "ManageEvent", new { Eventid = Model.PC_Eventid }, null)</p>
                        }
                        else
                        {
                            <p>@Html.ActionLink("Promotional Code", "CreatePromotionalCodes", "ManageEvent", new { Eventid = Model.PC_Eventid }, null)</p>
                        }
                        <p>Facebook Integration</p>
                        <p>Website Integration</p>
                        <p>Tracing Links</p>
                        <p>Affialate Programs</p>
                        <p>Social Stream</p>




                    </div>
                </div>
            </div>

        </div>
    </div>
}






<div class="col-sm-12 ">
    <h3 class="acnt_title">Create Promotional Code</h3>
    <!--  <p class="p_info">Payment Information</p> -->
</div>
<div class="clearfix"></div>

@using (Html.BeginForm("CreatePromotionalCodes", "ManageEvent", FormMethod.Post, new { enctype = "multipart/form-data" }))
{

    <div class="col-sm-10 mb10 col-xs-12" id="diverro1acc" style="display:none ">
        <div class="er_UI_main">


            <div class="er_sys_img"></div>
            <div class="er_suc" id="erraccsucc"></div>
            <button class="close" type="button" onclick="$('#diverro1acc').css('display', 'none');" id="btndiverro1acc" tabindex="-1">&#215;</button>
        </div>

    </div>
    <div class="col-sm-12 col-xs-12 ">
        <div class="col-sm-12 no_pad mb20">
            <ul class="cod_dis_type">
                <li><a class="active" href="#">Coded Discount</a></li>
                <li><a href="#">Public Discount</a></li>
                <li><a href="#">Special Access</a></li>
            </ul>
        </div>
        <div class="clearfix"></div>
        <div class="col-sm-12 no_pad mt20">
                <div class="col-sm-2 no_pad">
                    <div class="form-group">
                        <input class="form-control evnt_inp_cont" type="text" placeholder="Enter Single Promo Code" id="txt_Promocode" name="PC_Code" value="@Model.PC_Code">
                    </div>
                </div>
            @if (Model.Formtype == "S")
            {
                <div class="mid_or_width">or</div>
                <div class="custom_file_upload">
                    <div class="form-group">
                        <div class="file_upload">
                            <input type="file" id="file_upload" name="file" >
                        </div>
                        <label id="id_filename" class="filename" style="display:none"></label>
                        <input id="id_close" type="button" class="filename" style="display:none" value="X" />
                       
                    </div>
                </div>

                <div class="upload_help_icn">
                    <div class="tip">
                        <img class="help_icon_hov" src="/Images/icon-question.gif" />
                        <span class="upload_help_icn_inner">
                            Spaces apostrophes and non alphanumeric characters
                            (except '-','_',@@ and',' are not allowed. File must be in plain text
                            ( CSV or TXT)
                        </span>
                    </div>
                </div>
            }
        </div>
    <div class="clearfix"></div>
    <div class="col-sm-12 no_pad mt10">
      <input type="hidden" id="hd_eventid" name="PC_Eventid" value="@Model.PC_Eventid" />
        <input type="hidden" name="Formtype" value="@Model.Formtype" />
        <input type="hidden" name="PC_id" value="@Model.PC_id" />
        <input type="hidden" id="hd_pctype" name="PC_Type"  value="C"/>
@if (Model.Formtype == "S")
{
        <input type="hidden" id="hd_discounttype" name="Discount_Type" value="A" />
}
else
{
    if (Model.Amounttype == "A")
    {
        <input type="hidden" id="hd_discounttype" name="Discount_Type" value="A" />
    }
    else
    {
        <input type="hidden" id="hd_discounttype" name="Discount_Type" value="P" />
    }
}

        <input type="hidden" name="PC_Apply" id="hd_pcapply" value="@Model.PC_Apply"/>     
           <div class="col-sm-2 no_pad">
            <div class="form-group">
@if (Model.Formtype == "S")
{
                <input class="form-control evnt_inp_cont " type="text" placeholder="Enter Discount Amount" id="txt_discountmnt" name="PC_Amount" value="@Model.PC_Amount" >
}
else
{
    if (Model.Amounttype == "A")
    {
    <input class="form-control evnt_inp_cont " type="text" placeholder="Enter Discount Amount" id="txt_discountmnt" name="PC_Amount" value="@Model.PC_Amount">
    }
    else
    {
        <input class="form-control evnt_inp_cont " type="text" placeholder="Enter Discount Percentage" id="txt_discountmnt" name="PC_Amount" value="@Model.PC_Amount">

    }
}
            </div>
        </div>
        <div class="mid_or_width"></div>
        <div class="col-sm-1 no_pad">
            <div class="form-group dropheight">
                @if (Model.Formtype == "S")
                {
                <select class="form-control selectpicker" id="ddl_discounttype">
                    <option value="0">$</option>
                    <option value="1">%</option>
                </select>
                }
                else
                {
                    if (Model.Amounttype == "A")
                    {
                        <select class="form-control selectpicker" id="ddl_discounttype">
                            <option value="0" selected="selected">$</option>
                            <option value="1">%</option>
                        </select>
                    }
                    else
                    {
                        <select class="form-control selectpicker" id="ddl_discounttype">
                            <option value="0" selected="selected">$</option>
                            <option value="1" selected="selected">%</option>
                        </select>
                    }
                }
            </div>
        </div>
    </div>
     <div class="clearfix"></div>
        <div class="col-sm-12 no_pad mt10">
            <div class="col-sm-2 no_pad">
                <div class="form-group mt10">
                   Uses (Blank for Unlimited)
                </div>
            </div>
        
        <div class="mid_or_width"></div>
        <div class="col-sm-1 no_pad">
            <div class="form-group">
                <input class="form-control evnt_inp_cont " type="text" placeholder="Unlimited" id="txt_use" name="PC_Uses">
            </div>
        </div>
     </div>
   
    <div class="clearfix"></div>
    <div class="col-sm-12 no_pad mt10">
        <div class="col-md-6 col-sm-12  no_pad promo_checkbox">
            <div class="col-sm-4 no_pad">
                <div class="col-sm-12 no_pad">
                    <div class="prm_befor_level"> Start</div>
                    <div class="squaredOne">

                        <input type="checkbox" value="None" id="befstrtdevnt" name="check" />
                        <label for="befstrtdevnt"></label>
                    </div>
                    <div class="prm_cd_level"> before event</div>
                </div>
                <div class="col-sm-12 no_pad">
                    <div class="form-group">
                        <!-- <input class="form-control evnt_inp_cont " type="text" placeholder="Unlimited" > -->
                        <input type="text" class="form-control evnt_inp_cont" data-format="MM-dd-yyyy HH:mm AA" data-field="datetime" id="txtstartdate" name="PC_Start" value="@Model.PC_Start" />
                     
                    </div>

                </div>
            </div>
            <div class="col-sm-1 colsm1"></div>
            <div class="col-sm-4 no_pad">
                <div class="col-sm-12 no_pad">
                    <div class="prm_befor_level"> End</div>
                    <div class="squaredOne">
                        <input type="checkbox" value="None" id="befendevnt" name="check" />
                       
                    </div>
                    <div class="prm_cd_level"> before event</div>
                </div>
                <div class="col-sm-12 no_pad">

                    <div class="form-group">
                        <input type="text" class="form-control evnt_inp_cont " data-format="MM-dd-yyyy HH:mm AA" data-field="datetime" id="txtenddate" name="PC_End" value="@Model.PC_End" />
                        
                    </div>

                </div>
            </div>

        </div>



    </div>
    <div class="clearfix"></div>
    <div class="col-sm-12 no_pad mt10">
        <div class="col-md-6 col-sm-12 no_pad promo_checkbox">
            <div class="col-sm-12 apply_code_head">
                Apply Codes To These Tickets
            </div>
            <div class="col-sm-12 no_pad">
                <div class="squaredOne">
                    <input type="checkbox" value="0" id="all_ticket" name="Ticketcheck" />
                    <label for="all_ticket"></label>
                </div>
                <div class="prm_cd_level"> All</div>
            </div>
            @{ int i = 0;
                    foreach (var item in Model.Ticketdata)
                {
                    <div class="col-sm-12 no_pad">
                        <div class="squaredOne">
                            @if (item.TicketTypeID == 2)
                            {
                                <input type="checkbox" value="@item.T_Id" id="chk_@i" name="Ticketcheck" />

                            }
                            else
                            {
                                <input type="checkbox" value="@item.T_Id" id="chk_@i" name="Ticketcheck" disabled />
                            }
                            <label for="chk_@i"></label>
                        </div>
                            
                            <div class="prm_cd_level">
                           @if (item.TicketTypeID == 2)
                           {
                                <label>@item.T_name ($ @item.Price)</label>
                           }
                           else
                           {

                                    @item.T_name
                           }
                                    <input type="hidden" value="@item.T_Id" id="hdticket_@i" />
                                </div>
                            </div>
                    i = i + 1;
                }

                        }
                        


                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-sm-12 no_pad mt10">
                    <div class="col-md-6 col-sm-12 no_pad">
                        <div class="col-sm-12 apply_code_head">
                            <div class="col-sm-11 no_pad">Discout URL </div>
                            <div class="col-sm-1 no_pad text-right">
                                <img src="/Images/icon-question.gif" />
                            </div>

                        </div>
                        <div class="col-sm-12 no_pad mb10">
                            <div class="col-sm-9 ">
                            @if (Model.Formtype == "S")
                            {
                            <span class="dis_evnt_link">http://eventcombo.net/event-names?discount=Example</span>
                            }
                            else
                            {
                                <a class="link_url " name="PC_URL" href="#">http://eventcombo.net/event-names?discount=Example</a>
                            }
                                 @**@ </div>
                            <div class="col-sm-3  text-right">
@if (Model.Formtype == "S")
{
                                <button class="btn soc_btn_dis soc_btn_active" type="button"><i class="fa fa-facebook"></i></button>
                                <button class="btn soc_btn_dis soc_btn_active" type="button"><i class="fa fa-twitter"></i></button>
                                <button class="btn soc_btn_dis soc_btn_active" type="button"><i class="fa fa-envelope"></i></button>
}
else
{
    <button class="btn soc_btn_dis " type="button"><i class="fa fa-facebook"></i></button>
    <button class="btn soc_btn_dis " type="button"><i class="fa fa-twitter"></i></button>
                                <button class="btn soc_btn_dis " type="button"><i class="fa fa-envelope"></i></button>
}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-sm-12 no_pad mt10 mb10">
                    <button class="btn btn-info acnt_btn" type="submit" title="" id="btnsave">Save</button>
                </div>
            </div>
 }


<script>
          $(function() {
            $( document ).tooltip();
          });
</script>
            <script type="text/javascript">
                $(".upload_help_icn_inner").css("display", "none");
                $('.help_icon_hov').hover(
                 function () {
                     $(".upload_help_icn_inner").show();
                 },
                 function () {
                     $(".upload_help_icn_inner").hide();
                 }
               );


            </script>
            <script type="text/javascript">

                $(document).ready(function () {

                    var formtype = "@Model.Formtype";
                    if (formtype == "E") {
                        var PC_Apply = "@Model.PC_Apply";

                        if (PC_Apply == "") {

                        } else {
                            if (PC_Apply == "A") {
                                $("input[name='Ticketcheck']:not(:disabled)").prop('checked', 'checked');
                            } else {
                                if (PC_Apply.indexOf(",") > -1) {
                                    var dobPC_Apply = PC_Apply.split(",");

                                    for (var i = 0; i < dobPC_Apply.length; i++) {
                                        var cboxes = document.getElementsByName('Ticketcheck');
                                        var len = cboxes.length;

                                        for (var j = 0; j < len; i++) {

                                            if (cboxes[j].value == dobPC_Apply[i]) {
                                                document.getElementById(cboxes[i].id).checked = true;



                                            }



                                        }

                                    }

                                } else {

                                    var cboxes = document.getElementsByName('Ticketcheck');
                                    var len = cboxes.length;

                                    for (var i = 0; i < len; i++) {

                                        if (cboxes[i].value == PC_Apply) {
                                            document.getElementById(cboxes[i].id).checked = true;



                                        }



                                    }
                                }

                            }
                        }
                    }

                    $('#all_ticket').change(function () {
                        var apply = "";

                        if ($(this).is(":checked"))
                        {
                            $("#hd_pcapply").val("A");
                            $("input[name='Ticketcheck']:not(:disabled)").prop('checked', $(this).prop("checked"));
                        } else {
                            $("#hd_pcapply").val("");
                            $("input[name='Ticketcheck']:not(:disabled)").prop('checked',true);
                            $(this).prop('checked', false);

                            var cboxes = document.getElementsByName('Ticketcheck');
                            var len = cboxes.length;
                            
                            for (var i = 0; i < len; i++) {
                                if (cboxes[i].checked)
                                {
                                    if (apply == '')
                                    {
                                        apply += cboxes[i].value;
                                    }else{
                                        apply += ','+cboxes[i].value
                                    }
                                   
                                }
                                
                            }
                            $("#hd_pcapply").val(apply);
                        }
                       
                       
                        
                  
                    });
                    $("input[name='Ticketcheck']").change(function () {
                      
                        var apply = "";
                        var cboxes = document.getElementsByName('Ticketcheck');
                        var len = cboxes.length;
                        var length=  $('[name=Ticketcheck]:checked').length;
                      
                        if (length == 0) {
                            $("#hd_pcapply").val('');
                        } else {
                           
                            for (var i = 0; i < len; i++) {
                                if (cboxes[i].checked) {
                                    if (cboxes[i].value != 0) {
                                        if (apply == '') {
                                            apply += cboxes[i].value;
                                        } else {
                                            apply += ',' + cboxes[i].value
                                        }
                                    }

                                }

                            }
                            if (!cboxes[0].checked) {
                                $("#hd_pcapply").val(apply);
                            }
                        }

                    });
                    $("input[id^='txt_discountmnt']").mask('000,000.00', { reverse: true });
                    $("#ddl_discounttype").change(function (e) {
                        $('#txt_discountmnt').val('');
                        if($("#ddl_discounttype").val()==0)
                        {
                            $('#hd_discounttype').val('A');
                            $("#txt_discountmnt").attr("placeholder", "Enter Discount Amount")

                        } else {
                            $('#hd_discounttype').val('P');
                            $("#txt_discountmnt").attr("placeholder", "Enter Discount Percentage")
                        }

                    });

                    $("#file_upload").change(function () {
                       
                        $('#txt_Promocode').val('');
                        var filename = $('input[type=file]').val().split('\\').pop();
                        var extension = filename.replace(/^.*\./, '');

                      
                        if (extension == filename) {
                            extension = '';
                        } else {
                            
                            extension = extension.toLowerCase();
                        }
                       
                        if(extension=="txt" || extension=="csv")
                        {
                           
                            $('#txt_Promocode').attr('disabled', true);
                            $(".file_upload").hide();
                            $("#id_filename").html(filename);
                            $(".filename").show();
                        } else {
                          
                            $('#diverro1acc').show();
                            $('#erraccsucc').html(ajaxsetup('PromotionalCode', 'PCValidpccodefile'));
                            $('html,body').animate({ scrollTop: 0 });
                            return false;
                        }
                     
                    });

                    $("#id_close").click(function () {
                        $(".file_upload").show();
                        $(".filename").hide();
                        $('#txt_Promocode').attr('disabled', false);

                        var fileUpload = $("[id*=file_upload]");
                        var id = fileUpload.attr("id");
                        var name = fileUpload.attr("name");

                        //Create a new FileUpload element.
                        var newFileUpload = $("<input type = 'file' />");

                        //Append it next to the original FileUpload.
                        fileUpload.after(newFileUpload);

                        //Remove the original FileUpload.
                        fileUpload.remove();

                        //Set the Id and Name to the new FileUpload.
                        newFileUpload.attr("id", id);
                        newFileUpload.attr("name", name);

                    });
                    $('#txt_Promocode').blur(function (e) {

                        var value = $(this).val();
                        if(value!='')
                        {
                            $("#file_upload").attr('disabled', true);
                        } else {
                            $("#file_upload").attr('disabled', false);
                        }


                    });
                    $('#txt_Promocode').keypress(function (e) {
                        var regex = new RegExp("^[a-zA-Z0-9@@_,-]+$");
                        var str = String.fromCharCode(!e.charCode ? e.which : e.charCode);
                        if (regex.test(str)) {
                            return true;
                        }

                        e.preventDefault();
                        return false;
                    });
                    $('#txt_discountmnt').keypress(function (e) {
                        var regex = new RegExp("^[0-9.]+$");
                        var str = String.fromCharCode(!e.charCode ? e.which : e.charCode);
                        if (regex.test(str)) {
                            
                           return true;
                        }
                        e.preventDefault();
                        return false;

                    });
                    $('#txt_use').keypress(function (e) {
                        var regex = new RegExp("^[0-9]+$");
                        var str = String.fromCharCode(!e.charCode ? e.which : e.charCode);
                        if (regex.test(str)) {

                            return true;
                        }
                        e.preventDefault();
                        return false;

                    });

                    $('#txt_discountmnt').keyup(function (e) {
                        var txt = parseFloat($(this).val().replace(',', ''));
                        var ddlval = $("#ddl_discounttype").val();
                        if (ddlval == 0) {
                            if (txt > 99999) {
                                $(this).val(99999);
                            }
                        } else {
                            if (txt > 100) {

                                $(this).val(100);
                            }
                        }
                    });

                    $("#ddl_discounttype").change(function () {

                        if( $("#ddl_discounttype").val()==0)
                        {
                            $("#hd_discounttype").val("A");
                        } else {
                            $("#hd_discounttype").val("P");
                        }

                    });
   
                    var bIsPopup = displayPopup();

                    $("#dtBox").DateTimePicker(

                    {
                        isPopup: bIsPopup,

                        addEventHandlers: function () {
                            var dtPickerObj = this;

                            $(window).resize(function () {
                                bIsPopup = displayPopup();
                                dtPickerObj.setIsPopup(bIsPopup);
                            });

                            dtPickerObj.setDateTimeStringInInputField($(".fillDateTime"));
                        }
                    });

                    $('#btnsave').click(function () {
                        var formtype = "@Model.Formtype";
                        if (formtype == "S") {
                            var filename = $('input[type=file]').val().split('\\').pop();
                            var extension = filename.replace(/^.*\./, '');


                            if (extension == filename) {
                                extension = '';
                            } else {

                                extension = extension.toLowerCase();
                            }
                            if ($('#txt_Promocode').val() == '' && filename == '') {
                                $('#diverro1acc').show();
                                $('#erraccsucc').html(ajaxsetup('PromotionalCode', 'PCValidpccode'));
                                $('html,body').animate({ scrollTop: 0 });
                                return false;
                            }
                            if (filename != '') {
                                if (extension != 'txt' || extension != 'csv') {
                                    $('#diverro1acc').show();
                                    $('#erraccsucc').html(ajaxsetup('PromotionalCode', 'PCValidpccodefile'));
                                    $('html,body').animate({ scrollTop: 0 });
                                    return false;
                                }
                            }
                        } else {
                            if ($('#txt_Promocode').val() == '') {
                                $('#diverro1acc').show();
                                $('#erraccsucc').html(ajaxsetup('PromotionalCode', 'PCValidpccode'));
                                $('html,body').animate({ scrollTop: 0 });
                                return false;
                            }
                        }
                        var amnt = $('#txt_discountmnt').val();
                        if (amnt == '')
                        {
                            $('#diverro1acc').show();
                            $('#erraccsucc').html(ajaxsetup('PromotionalCode', 'PCValidamount'));
                            $('html,body').animate({ scrollTop: 0 });
                            return false;
                        }
                        var length = $('[name=Ticketcheck]:checked').length;
                        if (length == 0)
                        {
                            $('#diverro1acc').show();
                            $('#erraccsucc').html(ajaxsetup('PromotionalCode', 'PCselectcheckbox'));
                            $('html,body').animate({ scrollTop: 0 });
                            return false;
                        }
                       
                    });



                });



                function displayPopup() {
                    if ($(document).width() >= 768)
                        return false;
                    else
                        return true;


                }

                function ajaxsetup(strname, strFormTag) {
                    var msgnew = "";

                    var request = $.ajax({
                        url: '@Url.Action("Index", "ValidationMessage")',
                        async: false,
                        data: { strFormName: strname, strFormTag: strFormTag },
                        type: 'Post'
                    });
                    request.done(function (msg) {
                        msgnew += msg;
                    });

                    request.fail(function (jqXHR, textStatus) {
                        msgnew += "Some Error occur!!";
                    });
                    return msgnew;
                }

            </script>


